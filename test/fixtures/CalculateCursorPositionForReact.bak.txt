import * as React from "react";
import {
  calculateCursorPosition,
  formatMobile,
  formatBankCard
} from "util-helpers";

export default function App() {
  const [mobile, setMobile] = React.useState("");
  const [bankCard, setBankCard] = React.useState("");

  const changeMobile = (e) => {
    const el = e.target;
    const prevPos = el.selectionEnd;
    const rawValue = el.value;
    const ctrlValue = formatMobile(rawValue.replace(/\D/g, ""));
    const adjustPos = calculateCursorPosition(
      prevPos,
      mobile,
      rawValue,
      ctrlValue,
      { type: "mobile" }
    );
    setMobile(ctrlValue);

    if (rawValue !== ctrlValue) {
      setTimeout(() => {
        el.selectionStart = el.selectionEnd = adjustPos;
      });
    } else {
      el.selectionStart = el.selectionEnd = adjustPos;
    }
  };

  const changeBankCard = (e) => {
    const el = e.target;
    const prevPos = el.selectionEnd;
    const rawValue = el.value;
    const ctrlValue = formatBankCard(rawValue.replace(/\D/g, ""));
    const adjustPos = calculateCursorPosition(
      prevPos,
      bankCard,
      rawValue,
      ctrlValue,
      { type: "bankCard" }
    );
    setBankCard(ctrlValue);

    if (rawValue !== ctrlValue) {
      setTimeout(() => {
        el.selectionStart = el.selectionEnd = adjustPos;
      });
    } else {
      el.selectionStart = el.selectionEnd = adjustPos;
    }
  };

  return (
    <div className="App">
      <h1>util-helpers calculateCursorPosition 示例</h1>
      <p>
        <mark>React</mark> 计算格式化手机号码或银行卡号后的光标位置
      </p>
      <div>
        手机号码:{" "}
        <input
          type="text"
          placeholder="请输入"
          value={mobile}
          onChange={changeMobile}
        />
      </div>
      <div>
        银行卡号:{" "}
        <input
          type="text"
          placeholder="请输入"
          value={bankCard}
          onChange={changeBankCard}
        />
      </div>
      <p style={{ marginTop: 50, fontSize: 12, color: "gray" }}>
        * 如果选择范围含有间隔字符再粘贴，会产生错位
      </p>
    </div>
  );
}
